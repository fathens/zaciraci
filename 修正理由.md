# 修正の理由

## 概要

今回の修正は、`akaia.tkn.near.json`ファイルを`cli_tokens`の`predict kick`コマンドに与えた際に発生する`error decoding response body`エラーを解決するためのものです。

## 修正内容と理由

### 1. 実行ディレクトリの固定（`cli_tokens/top_predict.sh`）

**修正内容**：
スクリプトの実行ディレクトリに依存していた設定を変更し、常に`cli_tokens/.work`ディレクトリを基準にするように修正しました。具体的には、`CLI_TOKENS_BASE_DIR`環境変数のデフォルト値を現在のディレクトリ（`$(pwd)`）から、スクリプトの場所を基準とした`.work`ディレクトリ（`$SCRIPT_DIR/.work`）に変更しました。また、このディレクトリが存在しない場合は自動的に作成するようにしました。

**理由**：
- スクリプトの実行ディレクトリに依存していたため、異なるディレクトリから実行すると予測タスクが失敗していました
- 常に`cli_tokens/.work`ディレクトリを基準にすることで、どこから実行しても正しいパスでファイルを処理できるようになりました
- これにより、トークンファイルやヒストリーファイルのパスが一貫して解決されるようになり、「ファイルが見つからない」エラーを防止できます

### 2. 大きな値のスケーリング（`cli_tokens/src/commands/predict/kick.rs`）

**修正内容**：
予測リクエストを送信する前に、データ値が非常に大きい（100万以上）場合に自動的にスケールダウンする処理を追加しました。具体的には、最大値で全ての値を割ることで、値の範囲を0〜1に正規化しています。また、スケーリングが行われた場合はユーザーに通知するメッセージを表示するようにしました。

**理由**：
- 非常に大きな値（100万以上）を持つデータを予測モデルに渡すと、数値的不安定性が発生し、サーバー側で処理できないことがありました
- 大きな値を自動的にスケールダウンすることで、数値的安定性を確保し、予測モデルが適切に処理できるようになりました
- これは特に`akaia.tkn.near.json`のような大きな価格値を持つトークンデータで重要でした

### 3. APIレスポンス処理の改善（`common/src/api/chronos.rs`）

**修正内容**：
APIレスポンスの処理方法を変更し、エラー発生時により詳細な情報を提供するようにしました。具体的には、レスポンスを直接デシリアライズする代わりに、まずテキストとして取得し、その内容をログに出力してから解析するようにしました。また、エラーメッセージにレスポンス本文を含めるようにしました。

**理由**：
- 元のコードでは、APIレスポンスを直接デシリアライズしていたため、エラーが発生した場合に具体的な内容がわかりませんでした
- 修正後は、まずレスポンスをテキストとして取得し、その内容をログに出力してから解析するようにしました
- これにより、`error decoding response body`のような抽象的なエラーではなく、具体的なエラー内容とレスポンス本文を確認できるようになりました
- 同様の修正を`predict`メソッドにも適用し、一貫したエラー処理を実現しました

## 総括

これらの修正により、以下の問題が解決されました：

1. 実行ディレクトリに依存せず、常に正しいパスでファイルを処理できるようになりました
2. 大きな値を持つデータも適切に処理できるようになり、数値的安定性が向上しました
3. APIエラーが発生した場合に、より詳細な情報を得られるようになり、デバッグが容易になりました

これらの改善により、`akaia.tkn.near.json`ファイルを使った予測タスクが正常に実行できるようになり、ユーザー体験が向上しました。