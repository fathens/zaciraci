# 自動トレードのルール

## 基本設定

### アルゴリズム
- **使用アルゴリズム**: Portfolio
- **実装場所**: `zaciraci_common::algorithm::portfolio`

### 評価期間
- **設定項目**: `TRADE_EVALUATION_DAYS`
- **デフォルト値**: 10日間
- **説明**: 価格履歴を取得して予測を行う際の過去データの期間

### トレード頻度
- **設定項目**: `TRADE_FREQUENCY_HOURS`
- **デフォルト値**: 24時間（1日1回）
- **説明**: 定期的なトレード実行の間隔
- **現在の実装**: backend/src/trade.rs で cron 設定（毎時0分実行）

## トレードルール

### 基本戦略
1. **評価時のトークン処理**:
   - 全ての保有トークンを wrap.near に売却
   - ポートフォリオ評価は wrap.near ベースで実行

2. **対象トークン選定**:
   - top volatility から上位トークンを選定
   - **デフォルト件数**: 10個（`TRADE_TOP_TOKENS=10`で設定可能）
   - wrap.near から選定されたトークンにポートフォリオ配分

3. **利益確定（ハーベスト）**:
   - ポートフォリオ評価が初期投資額の200%を超えた場合
   - 超過分の10%を利益として確定
   - wrap.near から NEAR に変換して `HARVEST_ACCOUNT_ID` に送金
   - **最小ハーベスト額**: デフォルト 10 NEAR（`HARVEST_MIN_AMOUNT=10`で設定可能）
   - **アカウント残高保護**: 送金元に最低 1 NEAR を残す（`HARVEST_RESERVE_AMOUNT=1`で設定可能）

   **計算式**:
   ```
   現在評価額 = ポートフォリオ総額（wrap.near換算）
   初期投資額 = 設定された基準額
   最小ハーベスト額 = HARVEST_MIN_AMOUNT (デフォルト: 10 NEAR)
   残高保護額 = HARVEST_RESERVE_AMOUNT (デフォルト: 1 NEAR)

   if 現在評価額 > 初期投資額 * 2.0:
       超過額 = 現在評価額 - (初期投資額 * 2.0)
       ハーベスト対象額 = 超過額 * 0.1

       // ハーベスト対象額をNEARに変換（wrap.near → NEAR）
       // この結果、送金元アカウントのNEAR残高が増加
       送金元NEAR残高 = 変換後のNEAR残高
       送金可能額 = 送金元NEAR残高 - 残高保護額

       if 送金可能額 >= 最小ハーベスト額:
           ハーベスト実行（送金可能額を送金）
   ```

