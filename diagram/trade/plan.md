# 自動トレードの開発プラン

段階的に作っていく。

cli_tokens で Chronos API を使う実績のあるコードが common にあるのでそれを使う。

## ✅ Phase 0: Backend 自動トレード基盤 (完了)

**実装済み**: Portfolio アルゴリズムを使用した自動トレードシステムの基盤を backend に実装。

### 実装した機能

- **トレードエントリポイント**: `backend/src/trade/stats.rs` の `start()` 関数
- **資金準備**: NEAR → wrap.near 変換処理
- **トークン選定**: top volatility トークンの選択（PredictionService使用）
- **ポートフォリオ最適化**: 既存の Portfolio アルゴリズムを活用
- **価格予測**: Chronos API を使用した価格予測（PredictionService経由）
- **ボラティリティ計算**: BigDecimal を使用した高精度計算（Newton法平方根）
- **Cron統合**: `trade.rs` で毎時0分に自動実行

### ルール準拠

`rules.md` で定義されたトレードルールに完全対応:
- 評価頻度: 10日間（`TRADE_EVALUATION_DAYS`）
- トレード頻度: 毎時0分実行（24回/日）
- トークン選定: top 10 volatility（`TRADE_TOP_TOKENS`）
- ハーベスト: 200%超過の10%を収穫

### 設定パラメータ

- `TRADE_INITIAL_INVESTMENT`: 初期投資額
- `TRADE_TOP_TOKENS`: 選定トークン数（デフォルト: 10）
- `TRADE_EVALUATION_DAYS`: 評価頻度（デフォルト: 10日）
- `HARVEST_MIN_AMOUNT`: 最小ハーベスト額（デフォルト: 10 NEAR）
- `HARVEST_ACCOUNT_ID`: ハーベスト送金先

### 技術的実装詳細

- **データ精度**: f64 からの脱却を目指し BigDecimal 中心の実装
- **API統合**: 既存 PredictionService の活用でコード重複を排除
- **エラーハンドリング**: プレースホルダー関数を排除し適切なエラー処理を実装

## ✅ Phase 1: 取引記録と架空トレード (完了)

**実装済み**: トレード記録システムを完全実装。実際のトレード実行と記録機能が統合され、取引実績の追跡が可能。

### 必要なコード

#### 価格情報と予測

* ✅ 指定期間の top の取得（完了）
* ✅ 指定期間の history の取得（完了）
* ✅ 指定期間の情報を元に指定した日時の価格の予測（完了）

#### 予測を元にトレード

##### 決定アルゴリズム

* ✅ 保有トークンと他のトークンの価格予測を元にトレード内容を決定（完了）
* ✅ トレードの手数料を計算（完了）

**決定済み**: Portfolioアルゴリズムを使用

##### 架空トレード

* 実際にはトレードせずに DB に記録
* DB にあるトークンの保有量と価格を掛け合わせて資産評価

**実装予定**: trade_transactions テーブル（records.md 参照）

### ✅ trade_transactions テーブル実装状況 (完了)

#### ✅ Phase 1: 基本記録機能 (完了)
- [x] データベーススキーマ設計（records.md 完了）
- [x] Diesel migration ファイル作成 ✅ **2025-09-19 完了**
- [x] Rust struct 定義 (`TradeTransaction`) ✅ **2025-09-19 完了**
- [x] 基本的な記録機能実装 ✅ **2025-09-19 完了**
- [x] データベース接続とCRUD操作 ✅ **2025-09-19 完了**

#### ✅ Phase 2: 取引連携 (完了)
- [x] 実際の取引実行機能（execute_single_action 完了）
- [x] 取引成功時の自動記録 ✅ **2025-09-19 完了**
- [x] バッチID生成と管理 ✅ **2025-09-19 完了**
- [x] トランザクションハッシュの取得と保存 ✅ **2025-09-19 完了**
- [x] エラーハンドリング ✅ **2025-09-19 完了**

#### ✅ Phase 3: 分析機能 (完了)
- [x] ポートフォリオ価値の集計 ✅ **2025-09-19 完了**
- [x] 時系列データの取得 ✅ **2025-09-19 完了**
- [x] パフォーマンス分析 ✅ **2025-09-19 完了**

### 🏆 取引記録システム完成サマリー (2025-09-19)

**実装された主要機能:**
- ✅ **TradeTransaction構造体**: 同期・非同期CRUD操作完全対応
- ✅ **TradeRecorder**: バッチ管理と取引グループ化機能
- ✅ **自動記録統合**: execute_single_action での成功時自動記録
- ✅ **データベース設計**: 適切なインデックス付きtrade_transactionsテーブル
- ✅ **connection_poolカプセル化**: persistenceモジュール内完全封じ込め
- ✅ **テスト網羅**: 全38のトレード関連テスト成功
- ✅ **Migration実行**: PostgreSQL環境での動作確認完了

**技術的実装詳細:**
- **yoctoNEAR建て価格記録**: BigDecimal使用による高精度計算
- **バッチID管理**: UUID使用による取引グループ化
- **非同期データベース操作**: deadpool-dieselによる効率的な接続管理
- **適切なアーキテクチャ**: token_rateパターンに準拠したカプセル化

## ✅ Phase 2: 実際のトレード実行 (完了 - 2025-09-24)

**驚愕の事実**: Phase 2は既に完全実装済みでした！

### ✅ 必要なコード（全て実装済み）

#### ✅ 価格情報と予測
Phase 1 の実装を使用 - **実装済み**

#### ✅ 予測を元にトレード
Phase 1 の決定アルゴリズムを使用 - **実装済み**

##### ✅ 実際のトレード（完全実装済み）

* ✅ **Tx の作成と送信**: `execute_direct_swap()` で完全実装
  - arbitrage.rs パターンの活用
  - REF Finance との統合
  - プールパス検索とストレージデポジット処理

* ✅ **Tx の成否の確認**: `wait_for_success()` で実装
  - トランザクション待機機能
  - エラーハンドリング完備

* ✅ **DB に記録**: `TradeRecorder` で実装
  - バッチID管理
  - トランザクションハッシュ記録
  - yoctoNEAR建て価格記録

* ✅ **DB から資産評価**: 完全実装
  - `get_portfolio_value_by_batch_async()`
  - ハーベスト判定での利用

### 🎯 Phase 2 完了サマリー

**実装ファイル**:
- `trade/swap.rs`: 全TradingAction実行エンジン
- `trade/stats.rs`: `execute_trading_actions()` 統合
- `trade/recorder.rs`: 取引記録システム
- `trade/harvest.rs`: 利益確定機能

**主要機能**:
- 6種類のTradingActionパターン完全対応
- REF Financeとの完全統合
- 自動バッチ管理と取引記録
- リアルタイムポートフォリオ価値評価

**セットアップドキュメント**:
- `TRADING_SETUP.md` 作成済み（2025-09-24）

## ✅ Phase 0 完了済み項目 (2025-09-18 更新)

### 完了した重要な修正
1. **エラーハンドリング強化** ✅
   - 危険な `unwrap()` 呼び出しを適切なエラーハンドリングに変更
   - `get_top_quote_token()`, `get_base_tokens()` での適切なエラー処理
   - テスト修正と全テスト成功 (trade::stats: 13件, trade::predict: 7件)

2. **数値計算の修正** ✅
   - `calculate_liquidity_score()` の対数変換バグ修正
   - Newton法平方根計算でのBigDecimal精度確保
   - CI/CDチェック通過 (cargo clippy, cargo fmt)

3. **実際のトークン交換実行機能** ✅ **新規完了 (2025-09-18)**
   - `execute_single_action()` 関数の完全実装
   - arbitrage.rs のswapフレームワークを活用した実装
   - 全TradingActionパターンの対応:
     - `Hold`: ポジション保持
     - `Sell`: token → wrap.near → target (2段階swap)
     - `Switch`: from → to (直接swap)
     - `Rebalance`: 目標ウェイトに基づく複数swap実行
     - `AddPosition`: wrap.near → token swap
     - `ReducePosition`: token → wrap.near swap
   - `execute_direct_swap()` ヘルパー関数の実装
   - プールパス検索、ストレージデポジット、トランザクション待機まで含む完全な実装
   - ref_financeインフラとの完全統合

4. **f64からBigDecimalへの完全移行** ✅ **新規完了 (2025-09-18)**
   - 全財務計算でBigDecimal使用
   - 予測信頼度値のBigDecimal対応
   - 型整合性問題の解決
   - 全235テストの成功確認

## 🚧 次の優先実装項目

### 🔧 高優先度 (High Priority) - 即座に実装

1. ~~**実際のトークン交換実行**~~ ✅ **完了 (2025-09-18)**:
   - ~~`stats.rs:429-435`: `execute_single_action()` でのTODO実装~~ ✅
   - ~~既存 arbitrage.rs の swap 実装を活用してswap処理実装~~ ✅
   - ~~パス検索: token → wrap.near → target の経路最適化~~ ✅
   - ~~トランザクション成否の確認とエラーハンドリング~~ ✅
   - ~~**現在**: `warn!("swap execution not yet implemented")` 状態~~ ✅

2. ~~**f64 使用の完全排除**~~ ✅ **完了 (2025-09-18)**:
   - ~~Portfolio アルゴリズム用の f64 → BigDecimal 変換~~ ✅
   - ~~`predict.rs:44,179,414`: PredictedPrice の price, confidence フィールド~~ ✅
   - ~~外部ライブラリ制約への対応（zaciraci_common の構造体）~~ ✅

### ✅ 高優先度 (High Priority) - 完了済み

1. ~~**取引記録システムの実装**~~ ✅ **完了 (2025-09-19)** (records.md):
   - ✅ trade_transactions テーブルの作成
   - ✅ TradeTransaction struct の定義
   - ✅ 取引成功時の自動記録機能
   - ✅ バッチIDによる取引グループ管理
   - ✅ ポートフォリオ価値の時系列追跡

### ✅ 最高優先度 (Next Priority) - 完了済み

1. ~~**ハーベスト機能の実装**~~ ✅ **完了 (2025-09-23)**:
   - ✅ `check_and_harvest()` 関数の完全実装
   - ✅ 200%利益時の自動利益確定機能（初期投資額の2倍で発動）
   - ✅ wrap.near → NEAR 変換と送金処理の完全実装
   - ✅ ハーベスト条件判定の実装（時間間隔制御含む）
   - ✅ trade_transactions テーブルとの連携
   - ✅ **HARVEST_RESERVE_AMOUNT**: 残高保護機能（設定可能なNEAR残高の保護）
   - ✅ 包括的なテストスイート（6つのテストケース）

2. ~~**モジュール構造の整理**~~ ✅ **完了 (2025-09-23)**:
   - ✅ `harvest.rs`: ハーベスト機能を独立モジュールとして分離
   - ✅ `swap.rs`: スワップ実行機能を独立モジュールとして分離
   - ✅ モジュール間の責任分界の明確化

### ✅ 新規最高優先度 (New Priority) - リファクタリングと統合 (完了済み)

1. ~~**stats APIの機能回復**~~ ✅ **完了 (2025-09-23)**:
   - ✅ `SameBaseTokenRates::load()` の実装が退行により失われた問題の修復
   - ✅ TokenRate データベース読み取り機能の復旧
   - ✅ history コマンドの動作確認と修復

2. ~~**完成済み機能の適切な統合**~~ ✅ **完了 (2025-09-23)**:
   - ✅ harvest.rs モジュールのマージ（HARVEST_RESERVE_AMOUNT機能含む）
   - ✅ swap.rs モジュールのマージ（TradingAction実行機能含む）
   - ✅ モジュール構造の整理（機能を失わないリファクタリング）

3. ~~**回帰テストと動作確認**~~ ✅ **完了 (2025-09-23)**:
   - ✅ 全取引機能の動作確認（全テスト成功）
   - ✅ ハーベスト機能のテスト実行（static初期化問題解決）
   - ✅ history コマンドの実データ取得確認

### ✅ 特定された追加実装内容（real_tradeブランチから）- 統合完了

**完了済み機能（統合済み）**:
1. ~~**HARVEST_RESERVE_AMOUNT 機能**~~ ✅ **統合完了 (2025-09-23)**:
   - ✅ 環境変数による残高保護設定（デフォルト1 NEAR）
   - ✅ yoctoNEAR変換と残高計算ロジック
   - ✅ 包括的なテストスイート（default/custom/parsing/conversion tests）

2. ~~**モジュール分離の完了**~~ ✅ **統合完了 (2025-09-23)**:
   - ✅ `harvest.rs`: 214行の完全なハーベスト実装
   - ✅ `swap.rs`: TradingAction実行エンジンの分離
   - ✅ 適切な責任分界とモジュール設計

3. ~~**取引実行エンジンの強化**~~ ✅ **統合完了 (2025-09-23)**:
   - ✅ 全TradingActionパターンの実装（Hold/Sell/Switch/Rebalance/AddPosition/ReducePosition）
   - ✅ arbitrage.rsとの統合による実際のスワップ実行
   - ✅ 包括的なエラーハンドリングとトランザクション待機

4. ~~**データベース統合**~~ ✅ **統合完了 (2025-09-23)**:
   - ✅ trade_transactions テーブルとの完全連携
   - ✅ バッチIDによる取引グループ管理
   - ✅ ポートフォリオ価値の正確な追跡

### 🛠 中優先度 (Medium Priority)

1. **ハードコード値の実装**:
   - `stats.rs:318-319`: liquidity_score, market_cap の動的取得
   - 実際の流動性スコア計算アルゴリズム
   - 市場規模データの取得方法

### ✅ 新規完了項目 (2025-09-23)

#### ✅ リバランス計算の改善実装

**実装内容**:
- ✅ **現在保有量の実取得**: `get_current_portfolio_balances()` 関数の活用
- ✅ **総ポートフォリオ価値の計算**: `calculate_total_portfolio_value()` による正確な価値算出
- ✅ **目標量の精密計算**: 目標ウェイト × 総価値による各トークンの目標保有量算出
- ✅ **buy/sell判定の実装**: 現在保有量と目標量の差分による適切なアクション決定
- ✅ **最小交換額閾値**: 1 NEAR以上の差がある場合のみswap実行（無駄なswap回避）
- ✅ **詳細ログ出力**: buy/sell/no actionの判定理由とパラメータの詳細記録

**技術的改善**:
- ✅ f64 → BigDecimal変換の適切な処理（FromStr使用）
- ✅ エラーハンドリングの強化（BigDecimal変換エラー対応）
- ✅ モジュール間連携（swap.rsの関数をpublic化）

**解決したTODO**:
- ✅ `stats.rs:479`: "現在の保有量と目標量を比較してswap量を計算" の完全実装

### ✅ 新規完了項目 (2025-09-24)

#### ✅ 市場規模データの実データ化実装

**実装内容**:
- ✅ **実際のトークン発行量取得**: `get_token_total_supply()` 関数によるft_total_supply RPCコール
- ✅ **市場規模計算の改善**: `estimate_market_cap_async()` 関数で実際の発行量データを使用
- ✅ **ブロックチェーン連携**: NEAR RPCクライアントとの完全統合
- ✅ **エラーハンドリング**: RPC失敗時の適切なフォールバック処理
- ✅ **テストカバレッジ**: モック実装を使った包括的なテスト追加

**技術的改善**:
- ✅ JSONレスポンスの適切なパース処理（result.resultからの値抽出）
- ✅ `ExecutionOutcomeView` から `CallResult` への適切な型変換
- ✅ BigDecimal使用による高精度な市場規模計算

**解決したTODO**:
- ✅ `stats.rs:331,806`: "実際の発行量データをAPIから取得" の完全実装

#### ✅ ハーベスト機能の完全強化実装

**実装内容**:
- ✅ **トランザクションハッシュの正確な記録**: FinalExecutionOutcomeViewEnumからの実際のハッシュ取得
- ✅ **エラーハンドリングの強化**: withdraw, unwrap, transfer各段階での詳細ログと個別エラー処理
- ✅ **非同期処理の修正**: async/awaitパターンの適切な実装
- ✅ **統合テストの拡充**: しきい値計算、時間間隔チェック、設定パース等9つのテストケース

**技術的改善**:
- ✅ `wait_for_executed()` による正確なトランザクション結果取得
- ✅ `transaction_outcome.id` からのハッシュ抽出処理
- ✅ clippy警告の修正（unnecessary_lazy_evaluations対応）
- ✅ 段階的エラー処理によるデバッグ容易性向上

**解決した課題**:
- ✅ "harvest_tx_placeholder" → 実際のトランザクションハッシュ記録
- ✅ async/await構文エラーの修正
- ✅ ExecutionOutcomeView構造体の適切な活用

### 🔄 改善項目 (Low Priority)

1. **設定管理の強化**:
   - 環境変数による設定の外部化
   - 設定値のバリデーション
   - デフォルト値の適切な設定

2. **ログ・モニタリング機能**:
   - 取引実績の詳細記録
   - ポートフォリオパフォーマンスの追跡
   - アラート機能の実装

## 🎯 推奨する次のアクション

### ✅ Phase 0 完了: 実際のトレード実行機能

**~~最優先: 実際のトークン交換実行の実装~~** ✅ **完了 (2025-09-18)**

1. ~~**arbitrage.rs の分析**~~ ✅ **完了**:
   - ~~既存の swap 実装パターンを理解~~ ✅
   - ~~REF Finance API 呼び出し方法の把握~~ ✅
   - ~~パス検索アルゴリズムの理解~~ ✅

2. ~~**trade モジュールへの統合**~~ ✅ **完了**:
   - ~~`execute_single_action()` 関数の実装~~ ✅
   - ~~arbitrage.rs のコードを trade 用途に適応~~ ✅
   - ~~token → wrap.near → target の経路実装~~ ✅

3. ~~**テストと検証**~~ ✅ **完了**:
   - ~~swap 実行のテストケース作成~~ ✅
   - ~~トランザクション成否の確認機能~~ ✅
   - ~~エラーハンドリングの強化~~ ✅

### 次の実装ターゲット: 取引記録システムとハーベスト機能

**新しい最優先: 取引記録システム (records.md の実装)**

1. **trade_transactions テーブルの実装** (最優先):
   - Diesel migration ファイル作成
   - Rust struct 定義 (`TradeTransaction`)
   - 基本的な記録機能実装
   - 成功した取引の自動記録機能

2. **取引記録の統合** (優先度高):
   - `execute_single_action()` での取引成功時の記録
   - バッチIDによる関連取引のグループ化
   - トランザクションハッシュの保存
   - yoctoNEAR建て価格の記録

3. **分析機能の実装** (優先度中):
   - ポートフォリオ価値の時系列追跡
   - バッチ別の取引詳細表示
   - パフォーマンス分析クエリ

**次に優先: ハーベスト機能の実装**

1. **ポートフォリオ価値計算** (ハーベスト Phase A):
   - 現在の保有トークン残高取得
   - 各トークンの現在価格取得
   - 総ポートフォリオ価値の計算
   - **trade_transactions テーブルからの履歴データ活用**

2. **ハーベスト条件判定** (ハーベスト Phase B):
   - 初期投資額との比較
   - 200%超過時の10%利益確定ロジック
   - ハーベスト実行タイミングの判定
   - **取引履歴データに基づく利益計算**

3. **実際のハーベスト実行** (ハーベスト Phase C):
   - 利益分のトークン → wrap.near swap
   - wrap.near → NEAR 変換
   - 指定アドレスへの送金処理
   - **ハーベスト取引の記録**

これによりPhase 0が完全に完了し、取引実績の追跡が可能となり、Phase 1 (架空トレード記録) への準備が整います。

## 次のステップ

### 短期（Phase 0 完成 → Phase 1）

1. ~~**実際のトレード機能実装**~~ ✅ **完了 (2025-09-18)**:
   - ~~REF Finance 統合~~ ✅
   - ~~トランザクション処理~~ ✅
   - ~~arbitrage.rs との統合~~ ✅

2. ~~**データ精度問題の解決**~~ ✅ **完了 (2025-09-18)**:
   - ~~BigDecimal の完全採用~~ ✅
   - ~~外部ライブラリとの整合性確保~~ ✅

3. ~~**ハーベスト機能実装**~~ ✅ **完了 (2025-09-23)**:
   - ✅ ポートフォリオ価値計算とHARVEST_RESERVE_AMOUNT保護機能
   - ✅ 利益確定条件判定（200%利益時の発動）
   - ✅ 実際のハーベスト実行とトランザクション記録

4. **DB テーブル設計と実装**:
   - trade_transactions テーブル（実取引記録）
   - 架空トレード記録テーブル
   - ポートフォリオ評価履歴テーブル

### 中期（Phase 1 → Phase 2）

1. ~~**実際のトレード実行**~~ ✅ **完了 (2025-09-18)**:
   - ~~既存の swap 実装を活用~~ ✅
   - ~~トランザクション成否の確認~~ ✅
   - ~~エラーハンドリングとリトライ機能~~ ✅

2. **資金管理** (部分完了):
   - ~~NEAR/wrap.near 変換の実装~~ ✅
   - ハーベスト時の実際の送金処理 (TODO)

3. **モニタリング**:
   - トレード結果の追跡
   - パフォーマンス分析機能

## 🏆 Phase 0 完了サマリー (2025-09-18)

**Phase 0: Backend 自動トレード基盤** が完全に完了しました！

### 達成した主要機能
✅ **トレードエントリポイント**: `trade::stats::start()` 関数
✅ **資金準備**: NEAR → wrap.near 変換処理
✅ **トークン選定**: top volatility トークンの選択
✅ **ポートフォリオ最適化**: Portfolio アルゴリズムの完全統合
✅ **価格予測**: Chronos API を使用した価格予測
✅ **実際のトレード実行**: 全TradingActionパターンの完全実装
✅ **数値精度**: f64からBigDecimalへの完全移行
✅ **エラーハンドリング**: 堅牢なエラー処理の実装

### 現在の課題: 機能統合とリファクタリング
Phase 0は完全に完了しており、ハーベスト機能も含めて全ての機能が実装されています。

**主要問題**: リファクタリングプロセスで一部機能（stats API）に退行が発生しました。
**対応方針**: 機能を失わない適切なリファクタリングを実施し、全ての完成機能を統合する必要があります。

これが完了すれば、Phase 1 (架空トレード記録) への移行準備が整います。
